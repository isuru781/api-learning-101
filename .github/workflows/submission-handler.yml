name: Submission Handler

on:
  issues:
    types: [opened, closed]

jobs:
  handle-submission:
    runs-on: ubuntu-latest
    permissions:
      issues: write
      contents: read
      
    steps:
      - name: Check if submission issue
        id: check-submission
        run: |
          LABELS="${{ join(github.event.issue.labels.*.name, ',') }}"
          if [[ "$LABELS" == *"submission"* ]]; then
            echo "is_submission=true" >> $GITHUB_OUTPUT
          else
            echo "is_submission=false" >> $GITHUB_OUTPUT
          fi
          
      - name: Handle New Submission
        if: github.event.action == 'opened' && steps.check-submission.outputs.is_submission == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            // Add comment for new submission
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: `## ğŸ‰ Task Submission Successfully Received!
              
Thank you for completing the API Learning 101 testing task, @${ context.payload.issue.user.login }!

Your submission has been successfully received and is now **pending review**.

### ğŸ“‹ Submission Details

- **Submitter**: @${ context.payload.issue.user.login }
- **Issue**: #${ context.issue.number }
- **Status**: ğŸŸ¡ Pending Review
- **Assigned to**: @nisalgunawardhana

### â­ï¸ What's Next?

1. âœ… Your submission has been automatically assigned to @nisalgunawardhana for review
2. ğŸ” All 5 screenshots will be reviewed for completion and accuracy
3. ğŸ“§ You'll be notified once the review is complete
4. ğŸ† Upon approval, you'll receive your **API Learning 101 Completion Badge**!

### ğŸ“Š Review Criteria

Your submission will be evaluated based on:
- âœ“ All 5 API request types tested (GET all, GET one, POST, PUT, DELETE)
- âœ“ Screenshots show successful responses with correct status codes
- âœ“ All required fields visible in screenshots
- âœ“ Proper documentation in Pull Request

â³ **Please be patient** - Reviews are typically completed within 2-3 business days.

Thank you for your participation! ğŸ“`
            });
            
            // Ensure labels are set
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              labels: ['submission', 'pending review']
            });
            
            // Ensure assigned to nisalgunawardhana
            await github.rest.issues.addAssignees({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              assignees: ['nisalgunawardhana']
            });
            
      - name: Handle Closed Submission
        if: github.event.action == 'closed' && steps.check-submission.outputs.is_submission == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            // Check who closed the issue
            const closedBy = context.payload.sender?.login || 'unknown';
            const submitter = context.payload.issue.user.login;
            
            console.log(`Issue closed by: ${closedBy}`);
            
            // Only process if closed by nisalgunawardhana
            if (closedBy === 'nisalgunawardhana') {
              // Remove pending review label
              try {
                await github.rest.issues.removeLabel({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: context.issue.number,
                  name: 'pending review'
                });
              } catch (error) {
                console.log('Label already removed or does not exist');
              }
              
              // Add approval labels
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                labels: ['âœ… approved', 'ğŸ“ completed']
              });
              
              // Add congratulatory comment with badges
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: `## ğŸŠ Congratulations @${ submitter }!

Your **API Learning 101** task submission has been **approved** by @nisalgunawardhana!

### ğŸ† Achievement Unlocked!

You have successfully completed the API Learning 101 challenge and earned your badges:

- âœ… **Submission Approved Badge**
- ğŸ“ **API Learning 101 Completion Badge**

![Completion Badge](https://raw.githubusercontent.com/${context.repo.owner}/${context.repo.repo}/main/images/badges/badge.png)

### ğŸ“Š Your Submission Summary

- **All 5 API Tests**: âœ… Completed
- **Screenshots**: âœ… Verified  
- **Status Codes**: âœ… Correct
- **Documentation**: âœ… Proper

### ğŸ Want to Win Swags?

**Increase your chances to win:**
1. ğŸ“± Share your achievement on social media (Twitter/LinkedIn/Facebook)
2. ğŸ·ï¸ Tag **@NisalGunawardhana** and **@Postman**
3. ğŸ”– Use hashtag **#APILearning101**
4. ğŸ‰ Winners will be randomly selected for exclusive t-shirts and Postman swags!

### ğŸ‰ What You've Accomplished

You've demonstrated proficiency in:
- âœ“ RESTful API testing with Postman
- âœ“ Understanding HTTP methods (GET, POST, PUT, DELETE)
- âœ“ Validating API responses and status codes
- âœ“ Working with JSON data
- âœ“ API documentation and best practices

### ğŸš€ Next Steps

- Share your achievement on social media with #APILearning101 and tag @NisalGunawardhana & @Postman
- Continue exploring advanced API concepts
- Check out our other learning resources
- Help others by reviewing their submissions

### ğŸ T-Shirt & Swag Distribution

Winners will be **randomly selected** from all approved submissions! 

- T-shirts will be sent to randomly selected winners
- Your t-shirt size has been recorded
- Share on social media tagging @NisalGunawardhana and @Postman for bonus chances!
- Winners will be contacted separately for shipping details

**Tip:** The more engagement your post gets, the better your chances! ğŸ¯

---

**Thank you for completing API Learning 101!** Keep building amazing things! ğŸš€`
              });
              
              console.log(`âœ… Submission #${context.issue.number} approved for @${submitter}`);
              console.log(`Badges assigned: âœ… Approved, ğŸ“ Completed`);
            } else {
              console.log(`Issue closed by ${closedBy}, not nisalgunawardhana. No badges assigned.`);
            }

**Thank you for being an amazing contributor!** ğŸš€

*This issue has been automatically closed and labeled as reviewed.*`
              });
            } else {
              // If closed by someone else, just add a note
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: `This submission was closed by @${ closedBy }. For official review completion, the issue should be closed by @nisalgunawardhana.`
              });
            }
